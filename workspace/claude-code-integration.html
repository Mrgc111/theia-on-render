<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Integration</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .api-key-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 4px;
        }
        input[type="password"], input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .file-browser {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }
        .file-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .file-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .file-item:hover {
            background-color: #f0f0f0;
        }
        .file-item.selected {
            background-color: #e3f2fd;
        }
        .file-icon {
            width: 16px;
            height: 16px;
        }
        .editor-section {
            margin: 20px 0;
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px 4px 0 0;
        }
        #editor {
            width: 100%;
            min-height: 400px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            border: 1px solid #ddd;
            border-top: none;
            padding: 10px;
            background-color: #ffffff;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Claude Code Integration</h1>
        
        <div class="api-key-section">
            <h3>æ¥ç¶šçŠ¶æ…‹</h3>
            <button onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <span id="connectionStatus" style="margin-left: 10px;">æœªæ¥ç¶š</span>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="file-browser">
            <h3>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶</h3>
            <div>
                <input type="text" id="currentPath" value="/" readonly>
                <button onclick="refreshDirectory()">æ›´æ–°</button>
                <button onclick="createNewFile()">æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«</button>
                <button onclick="deleteSelectedFile()">å‰Šé™¤</button>
            </div>
            <ul id="fileList" class="file-list"></ul>
        </div>

        <div class="editor-section">
            <div class="editor-header">
                <span id="currentFile">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                <div>
                    <button onclick="saveFile()" id="saveButton" disabled>ä¿å­˜ (Ctrl+S)</button>
                    <button onclick="reloadFile()" id="reloadButton" disabled>å†èª­ã¿è¾¼ã¿</button>
                </div>
            </div>
            <textarea id="editor" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°è¦ä½œæˆã—ã¦ãã ã•ã„..."></textarea>
        </div>

        <div class="command-section">
            <h3>ğŸ› ï¸ ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ</h3>
            <input type="text" id="command" placeholder="å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ (ls, pwd, echo, node, npm, git status)">
            <button onclick="executeCommand()">å®Ÿè¡Œ</button>
            <pre id="commandOutput" style="background-color: #f8f8f8; padding: 10px; border-radius: 4px; display: none;"></pre>
        </div>
    </div>

    <script>
        let currentFilePath = null;
        let apiKey = 'default-api-key';

        // APIã‚­ãƒ¼ã®å–å¾—ï¼ˆèªè¨¼ç„¡åŠ¹æ™‚ã¯ä¸è¦ï¼‰
        function getApiKey() {
            return '';
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // APIå‘¼ã³å‡ºã—ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        async function apiCall(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': getApiKey(),
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'API Error');
            }

            return response.json();
        }

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            try {
                const result = await apiCall('/api/health');
                showStatus('æ¥ç¶šæˆåŠŸ: ' + result.status, 'success');
                document.getElementById('connectionStatus').textContent = 'âœ… æ¥ç¶šæ¸ˆã¿';
                document.getElementById('connectionStatus').style.color = 'green';
                refreshDirectory();
            } catch (error) {
                showStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                document.getElementById('connectionStatus').textContent = 'âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                document.getElementById('connectionStatus').style.color = 'red';
            }
        }

        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ›´æ–°
        async function refreshDirectory() {
            try {
                const path = document.getElementById('currentPath').value.replace(/^\//, '');
                const result = await apiCall(`/api/directory/${path}`);
                displayFiles(result.files);
            } catch (error) {
                showStatus('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º
        function displayFiles(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            files.sort((a, b) => {
                if (a.type !== b.type) {
                    return a.type === 'directory' ? -1 : 1;
                }
                return a.name.localeCompare(b.name);
            });

            files.forEach(file => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <span class="file-icon">${file.type === 'directory' ? 'ğŸ“' : 'ğŸ“„'}</span>
                    <span>${file.name}</span>
                    <span style="color: #666; font-size: 0.9em; margin-left: auto;">
                        ${file.type === 'file' ? `${formatSize(file.size)}` : ''}
                    </span>
                `;
                
                li.onclick = () => {
                    if (file.type === 'directory') {
                        const currentPath = document.getElementById('currentPath').value;
                        const newPath = currentPath === '/' ? `/${file.name}` : `${currentPath}/${file.name}`;
                        document.getElementById('currentPath').value = newPath;
                        refreshDirectory();
                    } else {
                        selectFile(file.path);
                    }
                };
                
                fileList.appendChild(li);
            });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        async function selectFile(path) {
            try {
                // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
                
                const result = await apiCall(`/api/files/${path}`);
                currentFilePath = path;
                
                document.getElementById('currentFile').textContent = path;
                document.getElementById('editor').value = result.content;
                document.getElementById('saveButton').disabled = false;
                document.getElementById('reloadButton').disabled = false;
                
                // é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                const fileItems = document.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    if (item.textContent.includes(path.split('/').pop())) {
                        item.classList.add('selected');
                    }
                });
                
                showStatus(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${path}`, 'success');
            } catch (error) {
                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
        async function saveFile() {
            if (!currentFilePath) {
                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const content = document.getElementById('editor').value;
                await apiCall(`/api/files/${currentFilePath}`, {
                    method: 'PUT',
                    body: JSON.stringify({ content })
                });
                
                showStatus(`ä¿å­˜å®Œäº†: ${currentFilePath}`, 'success');
            } catch (error) {
                showStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å†èª­ã¿è¾¼ã¿
        async function reloadFile() {
            if (currentFilePath) {
                await selectFile(currentFilePath);
            }
        }

        // æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        async function createNewFile() {
            const fileName = prompt('ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!fileName) return;

            const currentPath = document.getElementById('currentPath').value;
            const filePath = currentPath === '/' ? fileName : `${currentPath.replace(/^\//, '')}/${fileName}`;

            try {
                await apiCall(`/api/files/${filePath}`, {
                    method: 'PUT',
                    body: JSON.stringify({ content: '' })
                });
                
                showStatus(`ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†: ${filePath}`, 'success');
                refreshDirectory();
                selectFile(filePath);
            } catch (error) {
                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        async function deleteSelectedFile() {
            if (!currentFilePath) {
                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            if (!confirm(`æœ¬å½“ã« ${currentFilePath} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                await apiCall(`/api/files/${currentFilePath}`, {
                    method: 'DELETE'
                });
                
                showStatus(`å‰Šé™¤å®Œäº†: ${currentFilePath}`, 'success');
                currentFilePath = null;
                document.getElementById('currentFile').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
                document.getElementById('editor').value = '';
                document.getElementById('saveButton').disabled = true;
                document.getElementById('reloadButton').disabled = true;
                refreshDirectory();
            } catch (error) {
                showStatus('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        async function executeCommand() {
            const command = document.getElementById('command').value;
            if (!command) {
                showStatus('ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                const result = await apiCall('/api/execute', {
                    method: 'POST',
                    body: JSON.stringify({ command })
                });
                
                const output = document.getElementById('commandOutput');
                output.textContent = result.stdout || result.stderr || '(å‡ºåŠ›ãªã—)';
                output.style.display = 'block';
                
                showStatus('ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå®Œäº†', 'success');
            } catch (error) {
                showStatus('ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
        });

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            testConnection();
        });
    </script>
</body>
</html>